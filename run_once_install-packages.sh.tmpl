#!/bin/sh
# These are packages I want on all my machines



# package list with package name for arch, debian
# arch, debian
packages="\
    base-devel,build-essential\
    git,git\
    git-lfs,git-lfs\
    fd,fdfind\
    ripgrep,ripgrep\
    ripgrep-all,ripgrep-all\
    neovim,neovim\
    broot,Idky\
    lsd,lsd\
    handlr,Idky\
    bat,bat\
    visual-studio-code-bin,Idky\
    htop,htop\
    openssh,Idky\
    fish,Idky\
    gparted,Idky\
    python-pipx,Idky\
    zoxide,Idky\
    tinyxxd,Idky\
    hexyl,Idky\
    starship,Idky\
    ttf-jetbrains-mono-nerd,Idky\
"

platforms="arch,debian"


{{ if eq .chezmoi.osRelease.idLike "arch" -}}
platform="arch"
{{ else if eq .chezmoi.osRelease.idLike "debian" -}}
# This could be for another OS
# I can check the data with `chezmoi data`
platform="debian"
{{ end -}}


selected_packages=""

# ensure platform is set and supported
if [ -z "$(echo $platforms | grep $platform)" ]; then
    echo "!! Platform $platform is not one of the supported platforms: $platforms"
    exit 1
fi


for pkg in $packages; do
    if [ "$platform" = "arch" ]; then
        pkg=$(echo $pkg | cut -d, -f1)
    elif [ "$platform" = "debian" ]; then
        pkg=$(echo $pkg | cut -d, -f2)
    fi
    selected_packages="$selected_packages $pkg"
done

if [ "$platform" = "arch" ]; then
    echo -e "\n\nCheking packages  (errors are shown for missing packages)"
    if ! yay -Q $selected_packages; then
        echo -e "\nNew packages needed, partial update or full update? (p/f)"
        echo "(partial updates are not recommended)"
        read -r update

        if [ "$update" = "p" ] || [ "$update" = "P" ]; then
            yay -Sy
        else
            yay -Syu
        fi

        echo -e "\ngoing to do: yay -S $selected_packages --needed"
        yay -S $selected_packages --needed
    fi
elif [ "$platform" = "debian" ]; then
    echo "Syncing packages for debian"
    sudo apt-get update
    echo "going to do: sudo apt-get install $selected_packages --noconfirm --assume-yes --fix-missing"
    sudo apt-get install $selected_packages --noconfirm --assume-yes --fix-missing
fi


################# PIPX #################

pipx_packages=(
    "shell-gpt"
    # more packages without , but just new lines
)

echo -e "\nChecking pipx packages"

for package in "${pipx_packages[@]}"; do
    pipx list | grep "$package" >/dev/null 2>&1 || (
        echo "Installing pipx $package..."
        pipx install "$package"
    )
done

pipx ensurepath > /dev/null 2>&1



services=(
    # none yet
)

for svc in "${services[@]}"; do
    echo -n "checking $svc... "
    systemctl is-enabled --type=service "$svc" > /dev/null && echo "already enabled" || (
        echo "\nEnableing $svc..."
        systemctl enable --now "$svc"
    )
done
